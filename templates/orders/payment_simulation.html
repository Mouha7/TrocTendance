{% extends 'base.html' %}
{% load static %}

{% block title %}Paiement s√©curis√© - TrocTendance{% endblock %}

{% block content %}
<div class="min-h-screen bg-flame-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- En-t√™te -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Paiement s√©curis√©</h1>
            <div class="flex items-center justify-center space-x-2">
                <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-green-700 font-medium">Connexion SSL s√©curis√©e</span>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} bg-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-50 border border-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-200 text-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-800 px-4 py-3 rounded-lg">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Formulaire de paiement -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Informations de paiement</h2>
                
                <form method="post" class="space-y-6" id="payment-form">
                    {% csrf_token %}
                    
                    <!-- Erreurs g√©n√©rales du formulaire -->
                    {% if form.non_field_errors %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            {% for error in form.non_field_errors %}
                                <p class="text-red-800">{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Mode de paiement -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-4">
                            {{ form.payment_method.label }}
                        </label>
                        <div class="space-y-3">
                            {% for choice in form.payment_method %}
                                <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer payment-option" data-method="{{ choice.data.value }}">
                                    {{ choice.tag }}
                                    <label for="{{ choice.id_for_label }}" class="ml-3 flex-1 cursor-pointer font-medium">
                                        {{ choice.choice_label }}
                                    </label>
                                    {% if choice.data.value == 'success' %}
                                        <div class="flex space-x-1">
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png" alt="Visa" class="h-6">
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" class="h-6">
                                        </div>
                                    {% elif choice.data.value == 'failure' %}
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" class="h-6">
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Champs de carte bancaire -->
                    <div id="card-fields" class="space-y-4">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label for="{{ form.card_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.card_number.label }} *
                                </label>
                                {{ form.card_number }}
                                {% if form.card_number.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.card_number.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="{{ form.card_expiry.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.card_expiry.label }} *
                                </label>
                                {{ form.card_expiry }}
                                {% if form.card_expiry.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.card_expiry.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.card_cvv.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.card_cvv.label }} *
                                </label>
                                {{ form.card_cvv }}
                                {% if form.card_cvv.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.card_cvv.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <label for="{{ form.card_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.card_name.label }} *
                            </label>
                            {{ form.card_name }}
                            {% if form.card_name.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.card_name.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- PayPal fields (masqu√©s) -->
                    <div id="paypal-fields" class="hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-blue-800 font-medium">Vous serez redirig√© vers PayPal pour finaliser votre paiement</p>
                            <p class="text-sm text-blue-600 mt-2">‚ö†Ô∏è Cette option simule un √©chec de paiement pour la d√©monstration</p>
                        </div>
                    </div>
                    
                    <!-- Virement fields (masqu√©s) -->
                    <div id="bank-fields" class="hidden">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-yellow-800 font-medium">Les instructions de virement vous seront envoy√©es par email</p>
                            <p class="text-sm text-yellow-600 mt-2">‚ö†Ô∏è Cette option simule une erreur technique pour la d√©monstration</p>
                        </div>
                    </div>
                    
                    <!-- Conditions -->
                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex items-start">
                            {{ form.accept_terms }}
                            <label for="{{ form.accept_terms.id_for_label }}" class="ml-2 text-sm text-gray-600">
                                {{ form.accept_terms.label }}
                            </label>
                        </div>
                        {% if form.accept_terms.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.accept_terms.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Boutons -->
                    <div class="flex justify-between pt-6">
                        <a href="{% url 'orders:checkout' product.id %}" class="btn-secondary text-center">
                            Retour
                        </a>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold text-lg px-8 py-3 rounded-lg transition-colors duration-200 shadow-lg">
                            üîí Payer {{ checkout_data.total_price|floatformat:"0g" }}FCFA
                        </button>
                    </div>
                </form>
            </div>

            <!-- R√©capitulatif de commande -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">R√©capitulatif de commande</h2>
                
                <!-- Produit -->
                <div class="flex items-center space-x-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    {% if product.images.first and product.images.first.image %}
                        <img src="{{ product.images.first.image.url }}" 
                             alt="{{ product.title }}"
                             class="w-16 h-16 object-cover rounded-lg">
                    {% else %}
                        <div class="w-16 h-16 bg-gradient-to-br from-flame-100 to-flame-200 flex items-center justify-center rounded-lg">
                            <span class="text-2xl">{{ product.category.icon|default:"üì¶" }}</span>
                        </div>
                    {% endif %}
                    
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">{{ product.title }}</h3>
                        <p class="text-sm text-gray-600">{{ product.get_condition_display }}</p>
                        <p class="text-sm text-gray-600">Vendu par {{ product.seller.get_full_name|default:product.seller.username }}</p>
                    </div>
                </div>
                
                <!-- D√©tail des prix -->
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between text-gray-600">
                        <span>Prix du produit</span>
                        <span>{{ checkout_data.product_price|floatformat:"0g" }}FCFA</span>
                    </div>
                    <div class="flex justify-between text-gray-600">
                        <span>Frais de service TrocTendance</span>
                        <span>{{ checkout_data.commission }}FCFA</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg text-gray-900 pt-3 border-t border-gray-200">
                        <span>Total</span>
                        <span class="text-green-600">{{ checkout_data.total_price|floatformat:"0g" }}FCFA</span>
                    </div>
                </div>
                
                <!-- S√©curit√© -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center mb-3">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="font-medium text-green-800">Protection des achats</span>
                    </div>
                    <ul class="text-sm text-green-700 space-y-1">
                        <li>‚Ä¢ Paiement 100% s√©curis√©</li>
                        <li>‚Ä¢ Protection contre la fraude</li>
                        <li>‚Ä¢ Remboursement garanti</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Informations s√©curit√© en bas -->
        <div class="mt-8 text-center">
            <div class="flex items-center justify-center space-x-6 text-sm text-gray-600">
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span>SSL 256-bit</span>
                </div>
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Donn√©es prot√©g√©es</span>
                </div>
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Support client</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript pour la gestion des modes de paiement -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentOptions = document.querySelectorAll('input[name="payment_method"]');
    const cardFields = document.getElementById('card-fields');
    const paypalFields = document.getElementById('paypal-fields');
    const bankFields = document.getElementById('bank-fields');
    
    function togglePaymentFields() {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
        // Masquer tous les champs
        cardFields.classList.add('hidden');
        paypalFields.classList.add('hidden');
        bankFields.classList.add('hidden');
        
        // Afficher les champs appropri√©s
        if (selectedMethod === 'success') { // Carte bancaire
            cardFields.classList.remove('hidden');
        } else if (selectedMethod === 'failure') { // PayPal
            paypalFields.classList.remove('hidden');
        } else if (selectedMethod === 'error') { // Virement
            bankFields.classList.remove('hidden');
        }
    }
    
    // Initial toggle
    togglePaymentFields();
    
    // Toggle on change
    paymentOptions.forEach(option => {
        option.addEventListener('change', togglePaymentFields);
    });
    
    // Format automatique du num√©ro de carte
    const cardNumber = document.getElementById('card-number');
    if (cardNumber) {
        cardNumber.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let matches = value.match(/\d{4,16}/g);
            let match = matches && matches[0] || '';
            let parts = [];
            for (let i = 0, len = match.length; i < len; i += 4) {
                parts.push(match.substring(i, i + 4));
            }
            if (parts.length) {
                e.target.value = parts.join(' ');
            } else {
                e.target.value = value;
            }
        });
    }
    
    // Format automatique de la date d'expiration
    const cardExpiry = document.getElementById('card-expiry');
    if (cardExpiry) {
        cardExpiry.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
    }
    
    // Pr√©-remplir avec des donn√©es de test pour la carte bancaire
    if (cardNumber && !cardNumber.value) {
        cardNumber.value = '4242 4242 4242 4242';
    }
    const cardExpiry2 = document.getElementById('card-expiry');
    if (cardExpiry2 && !cardExpiry2.value) {
        cardExpiry2.value = '12/25';
    }
    const cardCvv = document.getElementById('card-cvv');
    if (cardCvv && !cardCvv.value) {
        cardCvv.value = '123';
    }
    const cardName = document.getElementById('card-name');
    if (cardName && !cardName.value) {
        cardName.value = 'JEAN DUPONT';
    }
});
</script>
{% endblock %}